version: '{build}'

branches:
  only:
    - master
init:
  - git config --global core.autocrlf input
clone_depth: 1

image:
  - Visual Studio 2019
  - macos
  - Ubuntu2004

environment:
  BT_API:
    secure: 0SIbW51d73pYhmh4CehqtmGdksH4jBCD4uyTpeJPsNEx7fF5dGAikfSDVlR6HLGX
  GH_API:
    secure: 4YhqXzROm8WOjGMaeLJZj5fQi/yEV+o3XqgSdnGsYORTeAfCNODt3kmuTaPvAsaM
  APPVEYOR_TOKEN:
    secure: Ze65tHzYbKW8ll986XhBx18df/MtnyHkqsTtkM5+kr8=
  matrix:
    # dummy var enables for.matrix.only specific ENV vars below
    - DUMMY:

for:
-
  matrix:
    only:
      - image: Visual Studio 2019
  environment:
    COMPILER: msys2
    PLATFORM: x64
    MSYS2_ARCH: x86_64
    MSYS2_DIR: msys64
    MSYSTEM: MINGW64
    CACHEID: windows64
  install:
    - src\appveyor\0_install_win.bat
  artifacts:
    # final SASfit package
    - path: src\sasfit_*_*.zip
    - path: saskit\saskit_*.exe
  cache: # 1GB max with free accounts
    # do not use src packages zip/tar.gz as dependencies, checksum calc needs forever
    - 'src\gsl\%CACHEID%      -> src\gsl\CMakeLists.txt, src\cmake, src\CMakeLists.txt'
    - 'src\fftw\%CACHEID%     -> src\fftw\CMakeLists.txt, src\cmake, src\CMakeLists.txt'
    - 'src\tcl\%CACHEID%      -> src\tcl\CMakeLists.txt, src\cmake, src\CMakeLists.txt'
    - 'src\sundials\%CACHEID% -> src\sundials\CMakeLists.txt, src\cmake, src\CMakeLists.txt'
    - 'saskit\saskit_%CACHEID%.exe -> src\CMakeLists.txt, src\cmake, src\CMakeLists.txt'

-
  matrix:
    only:
      - image: macos
  environment:
    CACHEID: macos64
  init:
    - brew install p7zip
  install:
    - sh src/appveyor/0_install_macos.sh
  artifacts:
    # final SASfit package
    - path: src/sasfit_*_*.tar.bz2
    - path: saskit/saskit_*
  cache: # 1GB max with free accounts
    # do not use src packages zip/tar.gz as dependencies, checksum calc needs forever
    - 'src/gsl/$CACHEID      -> src/gsl/CMakeLists.txt, src/cmake, src/CMakeLists.txt'
    - 'src/fftw/$CACHEID     -> src/fftw/CMakeLists.txt, src/cmake, src/CMakeLists.txt'
    - 'src/tcl/$CACHEID      -> src/tcl/CMakeLists.txt, src/cmake, src/CMakeLists.txt'
    - 'src/sundials/$CACHEID -> src/sundials/CMakeLists.txt, src/cmake, src/CMakeLists.txt'
    - 'saskit/saskit_$CACHEID -> src/CMakeLists.txt, src/cmake, src/CMakeLists.txt'

-
  matrix:
    only:
      - image: Ubuntu2004
  environment:
    CACHEID: linux64
  install:
    - sudo apt-get update
    - sudo apt-get -y install python3-pip #libx11-dev
  artifacts:
    # final SASfit package
    - path: src/sasfit_*_*.tar.bz2
    - path: saskit/saskit_*
  cache: # 1GB max with free accounts
    # do not use src packages zip/tar.gz as dependencies, checksum calc needs forever
    - 'src/gsl/$CACHEID      -> src/gsl/CMakeLists.txt, src/cmake, src/CMakeLists.txt'
    - 'src/fftw/$CACHEID     -> src/fftw/CMakeLists.txt, src/cmake, src/CMakeLists.txt'
    - 'src/tcl/$CACHEID      -> src/tcl/CMakeLists.txt, src/cmake, src/CMakeLists.txt'
    - 'src/sundials/$CACHEID -> src/sundials/CMakeLists.txt, src/cmake, src/CMakeLists.txt'
    - 'saskit/saskit_$CACHEID -> src/CMakeLists.txt, src/cmake, src/CMakeLists.txt'
build_script:
  - sh src/appveyor/4_build.sh

after_build:
  - sh src/appveyor/6_after_build.sh

test:
  assemblies:
    # saskit base package created by CMake
    - sasfit\saskit\saskit_*.exe
    # assembled SASfit library combined with saskit base package
    - sasfit\sasfit.exe
    # final SASfit package for users
    - sasfit\src\sasfit_*_*.zip

#test_script:
#  - cmd: echo
##test_script:
## - '%APPVEYOR_BUILD_FOLDER%\dev\ci\appveyor\test.bat'

notifications:
  - provider: Email
    to:
      - sasfit-ci@ingobressler.net
    on_build_success: false

deploy:
    # deploy development builds on BinTray
  - provider: BinTray
    username: sasfit
    api_key: '%BT_API%'
    subject: sasfit
    repo:    development
    package: SASfit
    version: '%SASFIT_VERSION%' # should be set by cmake
    publish:  true
    artifact: /.*\.(tar\.bz2|zip)/
    on:
      branch: master

    # release tags from master branch on GitHub
  - provider: GitHub
    description: 'Replace me with a list of changes for this release!'
    auth_token: '%GH_API%'
    on:
#      branch: master
      APPVEYOR_REPO_TAG: true

after_deploy:
  - python3 --version
  # install packages needed by the after_deploy script
  - python3 -m pip install --user requests python-dateutil
  - python3 src/appveyor/8_after_deploy.py
  - python3 src/appveyor/citools/appveyor_keep_builds.py 10

# vim: set ts=2 sw=2 sts=2 tw=0 et:
