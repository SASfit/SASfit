version: '{build}'

branches:
  only:
    - saskit-update

init:
  - git config --global core.autocrlf input

clone_depth: 1

environment:
  BT_API:
    secure: 0SIbW51d73pYhmh4CehqtmGdksH4jBCD4uyTpeJPsNEx7fF5dGAikfSDVlR6HLGX
  GH_API:
    secure: 4YhqXzROm8WOjGMaeLJZj5fQi/yEV+o3XqgSdnGsYORTeAfCNODt3kmuTaPvAsaM
  matrix:
    - COMPILER: msys2
      PLATFORM: x64
      MSYS2_ARCH: x86_64
      MSYS2_DIR: msys64
      MSYSTEM: MINGW64
      BIT: 64

install:
  - src\appveyor\install.bat

before_build:
  - sh src/appveyor/before_build.sh

build_script:
  - sh src/appveyor/build.sh

after_build:
  - sh src/appveyor/after_build.sh

cache: # 1GB max with free accounts
  # do not use src packages zip/tar.gz as dependencies, checksum calc needs forever
  #- 'src\gsl\windows64_%COMPUTERNAME%\include  -> src\gsl\CMakeLists.txt, src\cmake'
  - 'src\gsl\windows64_%COMPUTERNAME%      -> src\gsl\CMakeLists.txt, src\cmake, src\CMakeLists.txt'
  #- 'src\fftw\windows64_%COMPUTERNAME%\include -> src\fftw\CMakeLists.txt, src\cmake'
  - 'src\fftw\windows64_%COMPUTERNAME%     -> src\fftw\CMakeLists.txt, src\cmake, src\CMakeLists.txt'
  #- 'src\tcl\windows64_%COMPUTERNAME%\include  -> src\tcl\CMakeLists.txt, src\cmake'
  - 'src\tcl\windows64_%COMPUTERNAME%      -> src\tcl\CMakeLists.txt, src\cmake, src\CMakeLists.txt'
  #- 'src\sundials\windows64_%COMPUTERNAME%\include -> src\sundials\CMakeLists.txt, src\cmake'
  - 'src\sundials\windows64_%COMPUTERNAME% -> src\sundials\CMakeLists.txt, src\cmake, src\CMakeLists.txt'
  - 'saskit\saskit_windows64.exe -> src\CMakeLists.txt, src\cmake, src\CMakeLists.txt'

test:
  assemblies:
    # saskit base package created by CMake
    - sasfit\saskit\saskit_*.exe
    # assembled SASfit library combined with saskit base package
    - sasfit\sasfit.exe
    # final SASfit package for users
    - sasfit\src\sasfit_*_*.zip

test_script:
  - cmd: echo
#test_script:
# - '%APPVEYOR_BUILD_FOLDER%\dev\ci\appveyor\test.bat'

notifications:
  - provider: Email
    to:
      - sasfit-ci@ingobressler.net
    on_build_success: false

artifacts:
  # final SASfit package
  - path: src\sasfit_*_*.zip

deploy:
    # deploy development builds on BinTray
  - provider: BinTray
    username: sasfit
    api_key: '%BT_API%'
    subject: sasfit
    repo:    development
    package: SASfit
    publish:  true
    on:
      branch: saskit-update

    # release tags from master branch on GitHub
  - provider: GitHub
    description: 'Replace me with a list of changes for this release!'
    auth_token: '%GH_API%'
    on:
#      branch: master
      APPVEYOR_REPO_TAG: true

after_deploy:
  - sh src/appveyor/after_deploy.sh

# vim: set ts=2 sw=2 sts=2 tw=0 et:
